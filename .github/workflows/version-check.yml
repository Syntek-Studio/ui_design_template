# Version Consistency Check
#
# This workflow enforces that version numbers are updated whenever source code
# changes are made. It prevents accidental releases of code without version
# bumps and ensures changelog documentation is kept in sync with code changes.
#
# Purpose:
#   - Ensure version files are updated when code changes
#   - Prevent merging code without changelog documentation
#   - Maintain consistency between package.json and VERSION file
#   - Block PRs with code changes but missing version updates
#   - Provide clear guidance on semantic versioning
#
# Triggers:
#   - pull_request: On all PR activity to main, staging, dev, testing branches
#
# Permissions:
#   - contents:read - Read repository code and version files
#
# Checked Files:
#   - Source code: src/**/*.ts and src/**/*.tsx
#   - Version files: VERSION, CHANGELOG.md, RELEASES.md, VERSION-HISTORY.md, package.json
#
# Rules:
#   - If source code changes: at least one version file must be updated
#   - If only version files change: no error (documentation updates)
#   - Semantic versioning required: MAJOR.MINOR.PATCH format
#
# Semantic Versioning Guide:
#   - PATCH: Bug fixes and minor improvements
#   - MINOR: New features (backwards compatible)
#   - MAJOR: Breaking changes or major refactoring
#
# Notes:
#   - Uses git diff to compare with base branch
#   - Supports pre-release versions (e.g., 1.2.3-alpha)
#   - Error prevents PR merge until version files updated
#   - Encourages developers to document changes in CHANGELOG

name: Version Check

on:
  pull_request:
    branches: [main, staging, dev, testing]

jobs:
  # Job: Verify version files are updated with code changes
  # Purpose: Enforce consistent versioning and changelog updates
  # Failure impact: Blocks PR merge
  check-version:
    name: Check Version Updated
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Detect which files changed in this PR by comparing with base branch
      # Identifies source code changes and version file updates separately
      - name: Get changed files
        id: changed
        env:
          # SECURITY: Pass base_ref via env var to prevent shell injection
          BASE_REF: ${{ github.base_ref }}
        run: |
          # Get list of changed files in this PR
          # SECURITY: Using env var instead of direct interpolation
          CHANGED_FILES=$(git diff --name-only "origin/$BASE_REF"...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if source code was changed (TypeScript files in src/)
          CODE_CHANGED=$(echo "$CHANGED_FILES" | grep -E "^src/.*\.(ts|tsx)$" || true)

          # Check if any version files were updated
          # Includes: VERSION, CHANGELOG.md, RELEASES.md, VERSION-HISTORY.md, package.json
          VERSION_UPDATED=$(echo "$CHANGED_FILES" | grep -E "^(VERSION|CHANGELOG\.md|RELEASES\.md|VERSION-HISTORY\.md|package\.json)$" || true)

          if [ -n "$CODE_CHANGED" ]; then
            echo "code_changed=true" >> $GITHUB_OUTPUT
          else
            echo "code_changed=false" >> $GITHUB_OUTPUT
          fi

          if [ -n "$VERSION_UPDATED" ]; then
            echo "version_updated=true" >> $GITHUB_OUTPUT
          else
            echo "version_updated=false" >> $GITHUB_OUTPUT
          fi

      # Enforce version update requirement when source code changes
      # Fails if code changed but version files not updated
      - name: Check version requirement
        if: steps.changed.outputs.code_changed == 'true' && steps.changed.outputs.version_updated == 'false'
        run: |
          echo "::error::Source code was changed but version was not updated!"
          echo ""
          echo "Please update the following before merging:"
          echo "  1. VERSION file - bump the version number"
          echo "  2. CHANGELOG.md - document your changes"
          echo "  3. RELEASES.md - document your changes"
          echo "  4. VERSION-HISTORY.md - document your changes"
          echo "  5. package.json - update the version field"
          echo ""
          echo "Version format: MAJOR.MINOR.PATCH"
          echo "  - PATCH: Bug fixes"
          echo "  - MINOR: New features (backwards compatible)"
          echo "  - MAJOR: Breaking changes"
          echo ""
          exit 1

      # Success message when version checks pass
      - name: Version check passed
        if: steps.changed.outputs.code_changed == 'false' || steps.changed.outputs.version_updated == 'true'
        env:
          # SECURITY: Pass step outputs via env var
          CODE_CHANGED: ${{ steps.changed.outputs.code_changed }}
        run: |
          if [ "$CODE_CHANGED" == "false" ]; then
            echo "No source code changes - version update not required"
          else
            echo "Version files updated correctly"
          fi
