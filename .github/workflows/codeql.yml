# GitHub CodeQL Security Analysis
#
# This workflow uses GitHub's CodeQL to perform advanced static analysis,
# identifying potential security vulnerabilities and code quality issues in
# JavaScript and TypeScript code. CodeQL is GitHub's powerful semantic code
# analysis engine that understands code structure deeply.
#
# Purpose:
#   - Detect SQL injection, XSS, path traversal, and other security issues
#   - Identify code patterns that may lead to bugs or security problems
#   - Track security findings over time and across pull requests
#   - Provide deep semantic analysis beyond traditional linting
#
# Triggers:
#   - push: On commits to main, staging, dev, testing branches
#   - pull_request: On all PR activity to main, staging, dev, testing branches
#   - schedule: Weekly on Monday at 06:00 UTC (comprehensive analysis)
#
# Permissions:
#   - actions:read - Read workflow information
#   - contents:read - Read repository code
#   - security-events:write - Upload security findings to GitHub Security tab
#
# Languages Analysed:
#   - JavaScript/TypeScript (via security-and-quality query suite)
#
# Notes:
#   - Autobuild automatically detects and compiles TypeScript/JavaScript
#   - Results uploaded to GitHub's Code Security and Analysis section
#   - Weekly scheduled run provides comprehensive baseline analysis

name: CodeQL

on:
  push:
    branches: [main, staging, dev, testing]
  pull_request:
    branches: [main, staging, dev, testing]
  schedule:
    # Run comprehensive analysis weekly on Monday at 6am UTC
    # This is separate from push/PR analysis and catches issues not caught during development
    - cron: '0 6 * * 1'

jobs:
  # Job: CodeQL semantic code analysis
  # Purpose: Perform deep semantic analysis to find security and quality issues
  # Languages: JavaScript/TypeScript
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v6

      # Initialise CodeQL database and download query suites
      # Languages: JavaScript/TypeScript
      # Queries: security-and-quality suite includes both security and code quality checks
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          queries: security-and-quality

      # Automatically build TypeScript/JavaScript projects
      # CodeQL needs the code compiled to JavaScript to perform full analysis
      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      # Perform the CodeQL analysis and upload results to GitHub Security
      # Results are categorised by language for easy filtering
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:javascript-typescript'
